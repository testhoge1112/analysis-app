import os
import pandas as pd
from io import StringIO
from datetime import datetime
from datetime import datetime, date, timedelta  

# --- 生データ（raw）---
raw = """
台番	差枚	G数	出率	BB	RB	合成	BB率	RB率
544	1,561	7,608	106.8%	28	39	1/114	1/272	1/195
545	-440	1,562	90.6%	4	7	1/142	1/391	1/223
546	0	3,337	100%	13	8	1/159	1/257	1/417
547	-652	5,075	95.7%	17	12	1/175	1/299	1/423
548	-702	713	67.2%	1	0	1/713	1/713	-
549	-361	1,806	93.3%	6	3	1/201	1/301	1/602
550	451	6,829	102.2%	26	20	1/148	1/263	1/341
551	-740	563	56.2%	0	0	-	-	-
552	-348	3,759	96.9%	13	9	1/171	1/289	1/418
553	113	4,742	100.8%	17	16	1/144	1/279	1/296
554	2,217	5,357	113.8%	28	19	1/114	1/191	1/282
555	-219	930	92.2%	3	1	1/233	1/310	1/930
556	-622	526	60.6%	0	0	-	-	-
557	-269	4,083	97.8%	16	10	1/157	1/255	1/408
558	-556	621	70.2%	0	2	1/311	-	1/311
台番	差枚	G数	出率	BB	RB	合成	BB率	RB率
559	639	5,527	103.9%	21	22	1/129	1/263	1/251
560	-325	1,293	91.6%	3	5	1/162	1/431	1/259
561	1,578	8,634	106.1%	30	46	1/114	1/288	1/188
562	-18	2,984	99.8%	12	10	1/136	1/249	1/298
563	-808	1,566	82.8%	2	4	1/261	1/783	1/392
564	-724	2,517	90.4%	7	7	1/180	1/360	1/360
565	169	3,004	101.9%	13	6	1/158	1/231	1/501
587	993	4,917	106.7%	21	17	1/129	1/234	1/289
588	1,081	5,178	107%	20	26	1/113	1/259	1/199
589	-423	1,067	86.8%	2	4	1/178	1/534	1/267
590	-296	2,837	96.5%	11	4	1/189	1/258	1/709
591	2,266	6,269	112%	33	22	1/114	1/190	1/285
592	-265	472	81.3%	1	1	1/236	1/472	1/472
593	-932	4,976	93.8%	17	10	1/184	1/293	1/498
594	-502	375	55.4%	0	0	-	-	-
台番	差枚	G数	出率	BB	RB	合成	BB率	RB率
595	-144	1,140	95.8%	4	1	1/228	1/285	1/1140
596	-305	3,226	96.8%	11	7	1/179	1/293	1/461
597	720	2,029	111.8%	12	1	1/156	1/169	1/2029
598	-655	1,871	88.3%	6	1	1/267	1/312	1/1871
599	-361	3,133	96.2%	10	12	1/142	1/313	1/261
600	1,868	4,408	114.1%	25	12	1/119	1/176	1/367
601	721	6,762	103.6%	27	25	1/130	1/250	1/270
602	-355	1,072	89%	3	1	1/268	1/357	1/1072
603	-766	6,163	95.9%	17	23	1/154	1/363	1/268
604	-178	716	91.7%	2	2	1/179	1/358	1/358
605	726	7,546	103.2%	25	36	1/124	1/302	1/210
606	52	2,548	100.7%	10	7	1/150	1/255	1/364
671	1,522	4,404	111.5%	24	9	1/133	1/184	1/489
672	-387	4,266	97%	16	9	1/171	1/267	1/474
673	-559	1,212	84.6%	3	2	1/242	1/404	1/606
台番	差枚	G数	出率	BB	RB	合成	BB率	RB率
674	-2	4,410	100%	17	14	1/142	1/259	1/315
675	-370	1,459	91.5%	5	3	1/182	1/292	1/486
676	-285	474	80%	1	0	1/474	1/474	-
677	230	4,375	101.8%	16	14	1/146	1/273	1/313
678	1,155	4,264	109%	22	8	1/142	1/194	1/533
679	-449	2,593	94.2%	7	6	1/199	1/370	1/432
680	941	6,548	104.8%	26	23	1/134	1/252	1/285
681	808	1,252	121.5%	8	3	1/114	1/157	1/417
682	-332	1,612	93.1%	6	3	1/179	1/269	1/537
683	64	4,543	100.5%	18	11	1/157	1/252	1/413
689	710	3,241	107.3%	16	8	1/135	1/203	1/405
690	-1,339	2,592	82.8%	6	3	1/288	1/432	1/864
691	842	1,375	120.4%	8	4	1/115	1/172	1/344
692	1,817	7,655	107.9%	32	33	1/118	1/239	1/232
693	-728	1,415	82.9%	2	5	1/202	1/708	1/283
台番	差枚	G数	出率	BB	RB	合成	BB率	RB率
694	-467	4,108	96.2%	11	16	1/152	1/373	1/257
695	-427	339	58%	0	0	-	-	-
696	981	6,757	104.8%	28	19	1/144	1/241	1/356
697	-497	795	79.2%	1	1	1/398	1/795	1/795
698	-1,156	2,145	82%	5	4	1/238	1/429	1/536
699	-512	878	80.6%	1	2	1/293	1/878	1/439
700	444	6,071	102.4%	21	24	1/135	1/289	1/253
701	-257	298	71.3%	0	1	1/298	-	1/298
平均	73	3,218	100.8%	12	10	1/146	1/268	1/320

"""

# 1) 先頭の空行を除去
raw = raw.lstrip()

# 2) DataFrame に読み込む（1行目をヘッダーに）
df = pd.read_csv(StringIO(raw), sep='\t', header=0, dtype=str)

# 3) 繰り返しヘッダー行と平均行を除外（空白除去して判定）
df['台番'] = df['台番'].astype(str).str.strip()
df = df[~df['台番'].isin(['台番', '平均'])]

# 4) 各列の型変換（マイナス記号の正規化を追加）
def clean_num(s):
    s = str(s).replace(',', '')
    for char in "－−–—‐‑‒⁻₋▲▼":
        s = s.replace(char, '-')
    return s

df['台番'] = df['台番'].apply(clean_num).astype(int)
df['差枚'] = df['差枚'].apply(clean_num).astype(int)
df['G数'] = df['G数'].apply(clean_num).astype(int)
df['出率'] = df['出率'].str.rstrip('%').astype(float)
df['BB'] = df['BB'].apply(clean_num).astype(int)
df['RB'] = df['RB'].apply(clean_num).astype(int)

# 5) 出力先フォルダの準備
output_dir = r"C:\Users\akafu\analytics\aim_machi\data"
os.makedirs(output_dir, exist_ok=True)

# 6) ファイル名を自動組み立て
date_str = "2025-06-30"# YYYY-MM-DD形式で更新
weekday = datetime.strptime(date_str, "%Y-%m-%d").strftime("%a")
filename = f"aim-{date_str}-{weekday}.csv"
output_path = os.path.join(output_dir, filename)

# 7) CSV に書き出し
df.to_csv(output_path, index=False, encoding="utf-8-sig")
print(f"CSVを生成しました → {output_path}")
